<!DOCTYPE html>
<html>
<head>
    <title>IEM Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css')}}">
</head>
<body> 
    <div class="chatbot-toggle" id="togal" style="display:block">
        <div class="chatbot-icon">
            <i class="fas fa-comment-dots"></i>
        </div>
    </div>
    <div class="container-fluid h-100 chatbot-container" id="main-contain" style="display:none">
        <div class="row justify-content-center h-100">        
            <div class="col-md-3 col-xl-6 chat">
                <div class="card">
                    <!-- Chat Header -->
                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight">
                            <div class="img_cont">
                                <img src="/static/logo.png" class="rounded-circle user_img">
                                <span class="online_icon"></span>
                            </div>
                            <div class="user_info">
                                <span>IEM Assistant</span>
                                
                            </div>
                            <div class="chatbot-close">
                                <i class="fas fa-times"></i>
                            </div>
                        </div> 
                    </div>
                    
                    <!-- Phone Verification Section -->
                    <div id="phone-container">
                        <div id="otp-section">
                            <p>Please enter mobile number to continue</p>
                            <input type="tel" id="phone-number" placeholder="Enter phone number" maxlength="10">
                            <div id="phone-error" class="text-danger mt-2"></div>
                            <button id="submit-phone" class="btn-verify">Continue</button>
                        </div>
                    </div>
                    
                    <!-- Messages Container -->
                    <div id="messageFormeight" class="card-body msg_card_body">
                        <!-- Messages will appear here -->
                    </div>
                    
                    <!-- Chat Input (Initially Hidden) -->
                    <div class="card-footer" id="chat-section">
                        <form id="messageArea" class="input-group">
                            <input type="text" id="text" name="msg" placeholder="Type your message..." autocomplete="off" class="form-control type_msg" required>
                            <div class="input-group-append">
                                <button type="submit" id="send" class="input-group-text send_btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script >
        document.addEventListener("DOMContentLoaded", function() {
    // Phone number validation
    document.getElementById("submit-phone").addEventListener("click", validatePhoneNumber);
    $('.chatbot-toggle').click(function() {
        $('.chatbot-container').fadeToggle(300, function() {
            if ($('.chatbot-container').is(':visible')) {
                scrollToBottom();
            }
        }); 
        document.getElementById("togal").style.display = "none"; 
        document.getElementById("main-contain").style.display="block"
    }); 
    $('.chatbot-close').click(function() {
        $('.chatbot-container').fadeOut(300); 
        document.getElementById("togal").style.display = "block"; 
        document.getElementById("main-contain").style.display=" none"
    });
    // Message submission
    $("#messageArea").on("submit", function(event) {
        event.preventDefault();
        sendMessage();
    });

    function validatePhoneNumber() {
        let phone = document.getElementById("phone-number").value;
        let errorDiv = document.getElementById("phone-error");
        
        errorDiv.textContent = "";
        
        if (!/^\d{10}$/.test(phone)) {
            errorDiv.textContent = "Please enter a valid 10-digit phone number";
            return;
        }

        // Show loading state
        const btn = document.getElementById("submit-phone");
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
        btn.disabled = true;

        // Simulate verification
        setTimeout(function() {
            document.getElementById("phone-container").style.display = "none";
            document.getElementById("chat-section").style.display = "block";
            
            // Send welcome message
            addMessage("Hi! IEM is the 3rd best engineering college in West Bengal after IIT Kharagpur and NIT Durgapur, as per the NIRF ranking. How can I assist you with IEM-related queries today?", "bot");
            
            btn.innerHTML = 'Continue';
            btn.disabled = false;
        }, 1000);
    }

    function sendMessage() {
        const date = new Date();
        const str_time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        var rawText = $("#text").val();

        if (!rawText.trim()) return;

        // Add user message
        addMessage(rawText, "user");
        $("#text").val("");

        // Simulate bot response
        setTimeout(function() {
            // Replace with actual API call
            $.ajax({
                data: { msg: rawText },
                type: "POST",
                url: "/get"
            }).done(function(data) {
                addMessage(data, "bot");
            }).fail(function() {
                addMessage("Sorry, I'm having trouble connecting. Please try again.", "bot");
            });
        }, 500);
    }

    function addMessage(content, sender) {
        const container = $("#messageFormeight");
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        if (sender === "user") {
            container.append(`
                <div class="d-flex justify-content-end mb-4">
                    <div class="msg_cotainer_send">
                        ${content}
                        <span class="msg_time_send">${time}</span>
                    </div>
                    <div class="img_cont_msg">
                        <img src="/static/images (1).png" class="rounded-circle user_img_msg">
                    </div>
                </div>
            `);
        } else {
            container.append(`
                <div class="d-flex justify-content-start mb-4">
                    <div class="img_cont_msg">
                        <img src="/static/chatbot-conversation-vectorart_78370-4107.png" class="rounded-circle user_img_msg">
                    </div>
                    <div class="msg_cotainer">
                        ${content}
                        <span class="msg_time">${time}</span>
                    </div>
                </div>
            `);
        }
        
        // Scroll to bottom
        container.scrollTop(container[0].scrollHeight);
    }
});

    </script>
</body>
</html>